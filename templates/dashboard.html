{% extends 'base.html' %}

{% block title %}Dashboard - LeadNgN{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-light mb-0">
            <i class="fas fa-tachometer-alt text-primary me-2"></i>
            Lead Management Dashboard
        </h1>
        <p class="text-muted">Monitor and manage your lead generation pipeline</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="lead-score-high mb-0">{{ total_leads or 0 }}</h3>
                        <p class="text-muted mb-0">Total Leads</p>
                    </div>
                    <i class="fas fa-users fa-2x" style="color: var(--primary-gold); opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="lead-score-medium mb-0">{{ new_leads or 0 }}</h3>
                        <p class="text-muted mb-0">New Leads</p>
                        <small class="text-muted">Ready for review</small>
                    </div>
                    <i class="fas fa-star fa-2x glow-animation" style="color: var(--secondary-gold);"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="lead-score-medium mb-0">{{ qualified_leads or 0 }}</h3>
                        <p class="text-muted mb-0">Qualified</p>
                        <small class="text-muted">High potential</small>
                    </div>
                    <i class="fas fa-check-circle fa-2x" style="color: #00C9FF;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="lead-score-high mb-0">{{ converted_leads or 0 }}</h3>
                        <p class="text-muted mb-0">Converted</p>
                        <small class="text-muted">Revenue generated</small>
                    </div>
                    <i class="fas fa-trophy fa-2x glow-animation" style="color: #00D084;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filter & Sort Leads
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-control" name="industry" 
                               value="{{ current_filters.industry }}" 
                               placeholder="Filter by industry">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="">All Statuses</option>
                            <option value="new" {% if current_filters.status == 'new' %}selected{% endif %}>New</option>
                            <option value="contacted" {% if current_filters.status == 'contacted' %}selected{% endif %}>Contacted</option>
                            <option value="qualified" {% if current_filters.status == 'qualified' %}selected{% endif %}>Qualified</option>
                            <option value="converted" {% if current_filters.status == 'converted' %}selected{% endif %}>Converted</option>
                            <option value="rejected" {% if current_filters.status == 'rejected' %}selected{% endif %}>Rejected</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Quality</label>
                        <select class="form-select" name="quality">
                            <option value="">All Quality</option>
                            <option value="high" {% if current_filters.quality == 'high' %}selected{% endif %}>High (80+)</option>
                            <option value="medium" {% if current_filters.quality == 'medium' %}selected{% endif %}>Medium (40-79)</option>
                            <option value="low" {% if current_filters.quality == 'low' %}selected{% endif %}>Low (<40)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" name="sort">
                            <option value="created_at" {% if current_filters.sort == 'created_at' %}selected{% endif %}>Date Added</option>
                            <option value="quality_score" {% if current_filters.sort == 'quality_score' %}selected{% endif %}>Quality Score</option>
                            <option value="company_name" {% if current_filters.sort == 'company_name' %}selected{% endif %}>Company Name</option>
                            <option value="industry" {% if current_filters.sort == 'industry' %}selected{% endif %}>Industry</option>
                        </select>
                    </div>
                    
                    <div class="col-md-1">
                        <label class="form-label">Order</label>
                        <select class="form-select" name="order">
                            <option value="desc" {% if current_filters.order == 'desc' %}selected{% endif %}>Desc</option>
                            <option value="asc" {% if current_filters.order == 'asc' %}selected{% endif %}>Asc</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-filter me-1"></i>Apply
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Leads Table -->
<div class="row">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Recent Leads
                </h5>
                <div>
                    <a href="/leads" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>View All
                    </a>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="startScraping()">
                            <i class="fas fa-spider me-1"></i>New Scraping
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testFeatures()">
                            <i class="fas fa-flask me-1"></i>Test Features
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if leads %}
                <div class="table-responsive">
                    <table class="table table-dark lead-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Industry</th>
                                <th>Quality Score</th>
                                <th>Status</th>
                                <th>Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in leads %}
                            <tr class="lead-row">
                                <td>
                                    <div class="fw-bold">{{ lead.company_name }}</div>
                                    {% if lead.website %}
                                    <small class="text-muted">
                                        <i class="fas fa-globe me-1"></i>
                                        <a href="{{ lead.website }}" target="_blank" class="text-info">Website</a>
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.contact_name %}
                                    <div>{{ lead.contact_name }}</div>
                                    {% endif %}
                                    {% if lead.email %}
                                    <small class="text-muted">
                                        <i class="fas fa-envelope me-1"></i>{{ lead.email }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.industry %}
                                    <span class="industry-tag">{{ lead.industry }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.quality_score >= 80 %}
                                    <span class="lead-score-high">{{ lead.quality_score }}</span>
                                    {% elif lead.quality_score >= 40 %}
                                    <span class="lead-score-medium">{{ lead.quality_score }}</span>
                                    {% else %}
                                    <span class="lead-score-low">{{ lead.quality_score or 0 }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.lead_status == 'new' %}
                                    <span class="badge bg-warning status-badge">New</span>
                                    {% elif lead.lead_status == 'contacted' %}
                                    <span class="badge bg-info status-badge">Contacted</span>
                                    {% elif lead.lead_status == 'qualified' %}
                                    <span class="badge bg-primary status-badge">Qualified</span>
                                    {% elif lead.lead_status == 'converted' %}
                                    <span class="badge bg-success status-badge">Converted</span>
                                    {% elif lead.lead_status == 'rejected' %}
                                    <span class="badge bg-danger status-badge">Rejected</span>
                                    {% else %}
                                    <span class="badge bg-secondary status-badge">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ lead.created_at.strftime('%Y-%m-%d') if lead.created_at else '-' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="/lead/{{ lead.id }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="editLead({{ lead.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No leads found</h5>
                    <p class="text-muted">Start by setting up a scraping session to collect leads.</p>
                    <a href="/scraping" class="btn btn-primary">
                        <i class="fas fa-spider me-2"></i>Start Scraping
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Industry Breakdown -->
{% if industry_stats %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Industry Breakdown
                </h5>
            </div>
            <div class="card-body">
                {% for industry, count in industry_stats %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ industry or 'Unknown' }}</span>
                    <span class="badge bg-primary">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Leads added this week</span>
                    <span class="badge bg-success">{{ recent_leads or 0 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Conversion rate</span>
                    <span class="badge bg-info">
                        {% if total_leads and converted_leads %}
                        {{ "%.1f"|format((converted_leads / total_leads) * 100) }}%
                        {% else %}
                        0.0%
                        {% endif %}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Avg. quality score</span>
                    <span class="badge bg-warning">
                        {% if leads %}
                        {{ "%.0f"|format(leads|sum(attribute='quality_score')/leads|length) }}
                        {% else %}
                        0
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Enhanced Dashboard Functionality
let dashboardStats = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    setupRealTimeUpdates();
    animateStatCards();
});

// Load dashboard statistics
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        dashboardStats = await response.json();
        updateStatCards();
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        showNotification('Failed to load dashboard statistics', 'error');
    }
}

// Update stat cards with animation
function updateStatCards() {
    const cards = document.querySelectorAll('.stat-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.transform = 'translateY(-5px)';
            setTimeout(() => {
                card.style.transform = 'translateY(0)';
            }, 200);
        }, index * 100);
    });
}

// Animate stat cards on load
function animateStatCards() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animation = 'fadeInUp 0.6s ease forwards';
            }
        });
    });

    document.querySelectorAll('.stat-card').forEach(card => {
        observer.observe(card);
    });
}

// Test all advanced features
async function testFeatures() {
    showNotification('Testing LeadNGN advanced features...', 'info');
    
    const tests = [
        { name: 'Dashboard Stats', endpoint: '/api/dashboard/stats' },
        { name: 'AI Provider Status', endpoint: '/api/ai/provider/status' },
        { name: 'Notification Settings', endpoint: '/api/notifications/settings' },
        { name: 'Account Intelligence', endpoint: '/api/accounts/intelligence' }
    ];

    const testResults = document.createElement('div');
    testResults.className = 'alert alert-info mt-3';
    testResults.innerHTML = `
        <h5><i class="fas fa-flask text-warning me-2"></i>Feature Test Results</h5>
        <div id="test-progress"></div>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(testResults, container.firstChild);
    
    const progressDiv = document.getElementById('test-progress');
    
    for (let test of tests) {
        try {
            const response = await fetch(test.endpoint);
            const data = await response.json();
            
            const result = document.createElement('div');
            result.className = 'mb-2';
            result.innerHTML = `
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>${test.name}:</strong> 
                <span class="text-success">Working</span>
                <small class="text-muted d-block ms-4">Response: ${JSON.stringify(data).substring(0, 100)}...</small>
            `;
            progressDiv.appendChild(result);
        } catch (error) {
            const result = document.createElement('div');
            result.className = 'mb-2';
            result.innerHTML = `
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                <strong>${test.name}:</strong> 
                <span class="text-warning">Needs Setup</span>
                <small class="text-muted d-block ms-4">Error: ${error.message}</small>
            `;
            progressDiv.appendChild(result);
        }
        
        // Add delay between tests
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Auto-remove test results after 10 seconds
    setTimeout(() => {
        testResults.remove();
    }, 10000);
}

// Start scraping session
function startScraping() {
    showLoadingModal('Preparing scraping session...');
    window.location.href = '/scraping';
}

// Edit lead functionality
function editLead(leadId) {
    showLeadEditor(leadId);
}

// Show lead editor modal
function showLeadEditor(leadId) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--black-secondary); border: 1px solid var(--black-tertiary);">
                <div class="modal-header" style="border-bottom: 2px solid var(--primary-gold);">
                    <h5 class="modal-title text-light">
                        <i class="fas fa-edit text-warning me-2"></i>Edit Lead #${leadId}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-4">
                        <div class="loading-shimmer" style="height: 200px; border-radius: 10px;">
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <i class="fas fa-spinner fa-spin fa-2x text-warning me-3"></i>
                                <span class="text-light">Loading lead details...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--black-tertiary);">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Remove modal from DOM when closed
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 9999; 
        min-width: 300px;
        background: var(--black-secondary);
        border: 1px solid var(--primary-gold);
        color: white;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Show loading modal
function showLoadingModal(message) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--black-secondary); border: 1px solid var(--primary-gold);">
                <div class="modal-body text-center py-5">
                    <div class="loading-shimmer mb-3" style="height: 4px; border-radius: 2px;"></div>
                    <i class="fas fa-spinner fa-spin fa-3x text-warning mb-3"></i>
                    <h5 class="text-light">${message}</h5>
                    <p class="text-muted">Please wait while we process your request...</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal, { backdrop: 'static' });
    modalInstance.show();
    
    return modalInstance;
}

// Setup real-time updates
function setupRealTimeUpdates() {
    // Update dashboard stats every 30 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/api/dashboard/stats');
            const newStats = await response.json();
            
            // Check for changes and show notifications
            if (newStats.total_leads > dashboardStats.total_leads) {
                showNotification(`New lead added! Total: ${newStats.total_leads}`, 'success');
            }
            
            dashboardStats = newStats;
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }, 30000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'k':
                e.preventDefault();
                document.querySelector('input[name="industry"]').focus();
                break;
            case 't':
                e.preventDefault();
                testFeatures();
                break;
            case 'n':
                e.preventDefault();
                startScraping();
                break;
        }
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .stat-card {
        animation: fadeInUp 0.6s ease forwards;
        opacity: 0;
    }
    
    .lead-row {
        animation: fadeInUp 0.4s ease forwards;
        opacity: 0;
    }
    
    .lead-row:nth-child(odd) { animation-delay: 0.1s; }
    .lead-row:nth-child(even) { animation-delay: 0.2s; }
`;
document.head.appendChild(style);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Performance monitoring
let pageLoadTime = performance.now();
window.addEventListener('load', function() {
    const loadTime = performance.now() - pageLoadTime;
    console.log(`Dashboard loaded in ${loadTime.toFixed(2)}ms`);
    
    if (loadTime > 2000) {
        showNotification('Dashboard loaded slowly. Consider optimizing.', 'warning');
    }
});
</script>
{% endblock %}